from flask import Flask, jsonify, request, render_template
from flask_wtf.csrf import CSRFProtect
import time
import threading

app = Flask(__name__)
app.secret_key = "your_secret_key"
csrf = CSRFProtect(app)

# Simulated in-memory storage for share status
share_status = {
    "status": "pending",
    "results": []
}

# Simulated function to perform sharing
def simulate_sharing(link, limit):
    global share_status
    for i in range(limit):
        time.sleep(1)  # Simulate time delay for sharing
        success = i % 5 != 0  # Simulate occasional failure
        status = "success" if success else "error"
        message = f"Post {i + 1}: {'Shared successfully' if success else 'Failed to share'}"
        share_status["results"].append({
            "status": status,
            "message": message,
            "timestamp": time.strftime("%H:%M:%S")
        })
        share_status["status"] = "completed" if i == limit - 1 else "in_progress"

@app.route("/")
def index():
    # Pass form, link, and limit to the template
    return render_template("share_post.html", link="https://example.com/post", limit=10)

@app.route("/api/share/start", methods=["POST"])
@csrf.exempt
def share_start():
    global share_status
    share_status = {
        "status": "pending",
        "results": []
    }
    data = request.get_json()
    link = data.get("link")
    limit = data.get("limit", 10)

    if not link:
        return jsonify({"status": "error", "message": "Link is required"}), 400

    # Start sharing process in a separate thread
    threading.Thread(target=simulate_sharing, args=(link, limit)).start()
    return jsonify({"status": "success", "message": "Sharing started"})

@app.route("/api/share/status", methods=["GET"])
def share_status_api():
    global share_status
    return jsonify({
        "status": share_status["status"],
        "results": share_status["results"]
    })

if __name__ == "__main__":
    app.run(debug=True)